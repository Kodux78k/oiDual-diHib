<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>DUAL // FUSION OS — V2 Ultimate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#05070a">
<link rel="apple-touch-icon" href="./icon-192.png">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('Service Worker Registered'));
  }
</script>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --bg-deep:#030406; --glass-surface:rgba(18,18,22,0.65); --glass-border:rgba(255,255,255,0.06);
      --neon-cyan:#00f2ff; --neon-purple:#bd00ff; --neon-gold:#ffd700; --neon-danger:#ff2a6d; --neon-success:#00ff9d;
      --font-ui:'Montserrat',sans-serif; --font-code:'JetBrains Mono',monospace;
      --ease-overshoot: cubic-bezier(0.34, 1.3, 0.64, 1);
      --ease-smooth: cubic-bezier(0.23, 1, 0.32, 1);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none;user-select:none}
    .activation-pre, .cyber-input, input, textarea, .toaster { user-select:text !important; -webkit-user-select:text !important; }
    
    body{margin:0;padding:0;min-height:100vh;background-color:var(--bg-deep);color:#fff;
      font-family:var(--font-ui);overflow:hidden;
      background-image:linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size:50px 50px;
    }

    /* Ambient Light */
    .ambient-light{position:fixed;inset:0;z-index:0;pointer-events:none}
    .blob{position:absolute;border-radius:50%;filter:blur(100px);opacity:0.14;animation:float 25s infinite alternate ease-in-out}
    .blob-1{width:60vw;height:60vw;background:var(--neon-cyan);top:-20%;left:-20%}
    .blob-2{width:50vw;height:50vw;background:var(--neon-purple);bottom:-20%;right:-20%;animation-delay:-5s}
    @keyframes float{0%{transform:translate(0,0)}100%{transform:translate(40px,60px)}}

    /* Container Central */
    .container{
      position: absolute; inset:0; pointer-events:none;
      display:flex; align-items:center; justify-content:center; perspective:1200px; z-index:10;
    }

    /* O Card Principal */
    .fusion-card{
      pointer-events:auto;
      width:100%; max-width:440px;
      background:var(--glass-surface); backdrop-filter:blur(30px); -webkit-backdrop-filter:blur(30px);
      border:1px solid var(--glass-border); border-radius:36px; padding:30px 25px;
      box-shadow:0 40px 100px rgba(0,0,0,0.8);
      position:relative; opacity:0; transform:translateY(50px) scale(0.96);
      display:flex; flex-direction:column; gap:8px;
      transition: width 0.5s var(--ease-smooth), height 0.5s var(--ease-smooth), border-radius 0.5s var(--ease-smooth), transform 0.4s var(--ease-smooth), opacity 0.4s;
      will-change: transform, width, height, border-radius, left, top;
      touch-action: none; 
    }
    .fusion-card.active{opacity:1;transform:translateY(0) scale(1);}
    
    /* Estado CLOSED */
    .fusion-card.closed{width:260px; padding:14px 16px; border-radius:22px;} 
    .fusion-card.closed .card-body{display:none}
    
    /* ========================================= */
    /* ESTADO: ORB                               */
    /* ========================================= */
    .fusion-card.orb {
      position: fixed !important;
      width: 68px !important; height: 68px !important;
      padding: 0 !important; border-radius: 50% !important;
      align-items: center; justify-content: center;
      box-shadow: 0 15px 40px rgba(0,0,0,0.6), 0 0 20px rgba(0,242,255,0.2);
      z-index: 9999;
      cursor: grab;
    }
    .fusion-card.orb:active { cursor: grabbing; transform: scale(0.9); }
    
    /* Esconde elementos no modo ORB */
    .fusion-card.orb .text-block, .fusion-card.orb .clock-widget, .fusion-card.orb .card-body, .fusion-card.orb .small-preview { display: none !important; }
    .fusion-card.orb .card-header { margin: 0; width: 100%; height: 100%; justify-content: center; padding:0; }
    .fusion-card.orb .avatar-slot { width: 54px; height: 54px; border-radius: 50%; margin:0; opacity: 1; pointer-events: none; }

    /* ========================================= */
    /* ESTADO: HUD                               */
    /* ========================================= */
    .fusion-card.hud {
      position: fixed !important; top: 12px !important; left: 50% !important;
      transform: translateX(-50%) !important;
      width: 92% !important; max-width: 600px !important; height: 64px !important;
      padding: 0 16px !important; border-radius: 99px !important;
      flex-direction: row; align-items: center; justify-content: space-between;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 9999;
    }
    .fusion-card.hud .card-body, .fusion-card.hud .small-preview { display: none !important; }
    .fusion-card.hud .card-header { margin: 0; width: 100%; justify-content: space-between; }
    .fusion-card.hud .avatar-slot { width: 40px; height: 40px; }
    .fusion-card.hud .brand-dual { font-size: 1.2rem; margin:0; }
    .fusion-card.hud .greeting-row { display:none; } 
    .fusion-card.hud .text-block { flex: unset; }

    /* Internals */
    .card-header{display:flex;align-items:center;gap:15px;margin-bottom:18px; width:100%; cursor: pointer;}
    .avatar-slot{width:64px;height:64px;border-radius:18px;overflow:hidden;opacity:0;transition:opacity 0.35s}
    .avatar-slot.shown{opacity:1}
    
    .text-block{flex:1;display:flex;flex-direction:column;justify-content:center}
    .greeting-row{font-size:1.5rem;line-height:1;display:flex;align-items:baseline;gap:6px;flex-wrap:wrap}
    .txt-thin{font-weight:200;color:rgba(255,255,255,0.7)}
    .txt-heavy{font-weight:600;color:#fff}
    
    .brand-dual{font-size:2.2rem;font-weight:900;line-height:0.95;text-transform:uppercase;letter-spacing:-2px;margin-top:4px;
      background:linear-gradient(-45deg,#fff,var(--neon-cyan),var(--neon-purple),#fff);background-size:300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gradientFlow 4s ease infinite;
    }
    @keyframes gradientFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .clock-widget{text-align:right}
    .time-display{font-family:var(--font-code);font-size:1rem;color:rgba(255,255,255,0.5);font-weight:700}
    .status-led{font-size:0.6rem;color:var(--neon-cyan);text-transform:uppercase;letter-spacing:1px;margin-top:4px;display:block}

    /* Small Preview */
    .small-preview{display:none;align-items:center;gap:10px;margin-top:8px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-family:var(--font-code);font-size:0.86rem;color:rgba(255,255,255,0.9);cursor:pointer;}
    .small-preview .mini-avatar{width:30px;height:30px;border-radius:6px;flex-shrink:0;overflow:hidden;display:inline-flex;align-items:center;justify-content:center}
    .small-preview .small-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100% - 110px)}
    .small-preview .ident-badge{margin-left:auto;font-weight:700;font-size:0.78rem;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.02)}
    .fusion-card.closed:not(.orb):not(.hud) .small-preview{display:flex}
    
    .card-body{display:flex;flex-direction:column;gap:12px}
    .stagger-item{opacity:0;transform:translateY(15px);transition:opacity 0.4s ease, transform 0.4s var(--ease-overshoot)}
    .content-visible .stagger-item{opacity:1;transform:translateY(0)}
    .content-visible .stagger-item:nth-child(1){transition-delay:0.1s}
    .content-visible .stagger-item:nth-child(2){transition-delay:0.18s}
    .content-visible .stagger-item:nth-child(3){transition-delay:0.25s}

    .cyber-input{width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:16px 50px 16px 18px;color:#fff;font-family:var(--font-code);font-size:0.9rem}
    
    .activation-wrap{display:flex;flex-direction:column;gap:8px}
    .activation-card{background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:10px;overflow:hidden;transition:all 320ms var(--ease-smooth)}
    .activation-pre{font-family:var(--font-code);white-space:pre-wrap;margin:0;padding:8px;background:rgba(0,0,0,0.12);border-radius:8px;border:1px dashed rgba(255,255,255,0.03);color:#fff;font-size:0.75rem}
    .activation-hidden{max-height:0;opacity:0;padding:0 12px;pointer-events:none}
    .activation-open{max-height:400px;opacity:1;padding:12px}
    
    .trigger-btn{width:100%;padding:12px;border:1px dashed rgba(255,255,255,0.1);border-radius:12px;background:rgba(255,255,255,0.02);color:rgba(255,255,255,0.5);font-size:0.75rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;display:flex;justify-content:center;align-items:center;gap:8px}
    .trigger-btn:hover{background:rgba(255,255,255,0.04);color:#fff;border-color:rgba(255,255,255,0.3)}

    .stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
    .stat-box{background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;text-align:center}
    .stat-lbl{font-size:0.55rem;text-transform:uppercase;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px}
    .stat-val{font-family:var(--font-code);font-size:0.9rem;font-weight:700;color:var(--neon-cyan)}

    .progress-container{background:rgba(0,0,0,0.2);padding:12px;border-radius:12px}
    .bar-track{height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;margin:8px 0}
    .bar-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--neon-cyan),var(--neon-purple));box-shadow:0 0 10px var(--neon-cyan);transition:width 1.2s ease-out}
    .bar-meta{display:flex;justify-content:space-between;font-size:0.6rem;color:rgba(255,255,255,0.4);font-family:var(--font-code)}

    .toaster-wrap{position:fixed;right:20px;bottom:20px;z-index:99999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toaster{pointer-events:auto;background:linear-gradient(180deg,#0b1220,#071018);border:1px solid rgba(255,255,255,0.06);padding:10px 14px;border-radius:10px;box-shadow:0 18px 40px rgba(0,0,0,0.6);font-family:var(--font-ui);font-size:0.95rem;opacity:0;transform:translateY(8px);transition:all 260ms var(--ease-smooth)}
    .toaster.show{opacity:1;transform:translateY(0)}
    .toaster.error{border-color:var(--neon-danger);color:var(--neon-danger)}
    .toaster.success{border-color:var(--neon-success);color:var(--neon-success)}

    /* Keys Modal styles */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:99998;backdrop-filter:blur(8px)}
    .keys-card{width:90%;max-width:760px;background:linear-gradient(180deg,#071018,#0b1220);border:1px solid rgba(255,255,255,0.08);padding:20px;border-radius:16px;color:var(--text);box-shadow:0 20px 50px rgba(0,0,0,0.8);max-height:90vh;display:flex;flex-direction:column}
    .keys-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.05)}
    .key-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px;min-height:100px}
    .key-item{display:flex;align-items:center;gap:8px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
    .key-item.active-item{background:rgba(0, 242, 255, 0.05);border-color:rgba(0, 242, 255, 0.2)}
    .key-item .meta{flex:1}
    .small-btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);padding:6px 10px;border-radius:8px;color:#fff;cursor:pointer;font-size:0.75rem;text-transform:uppercase;font-weight:600;transition:0.2s}
    .small-btn:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.2)}
    .small-btn.active-btn{background:var(--neon-success);color:#000;border:none}
    .danger{color:var(--neon-danger);border-color:rgba(255,42,109,0.3)}
    .danger:hover{background:rgba(255,42,109,0.1)}

    .form-section{margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.05)}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
    .form-row{display:flex;gap:8px;}
    .form-row input, .form-grid input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:#030406;color:#fff;font-family:var(--font-code);font-size:0.85rem}
    .form-row input:focus, .form-grid input:focus{border-color:var(--neon-cyan)}

    /* Vault Modal */
    #vaultModal .keys-card{max-width:400px;text-align:center}
    .vault-icon{width:50px;height:50px;margin:0 auto 15px;color:var(--neon-purple);background:rgba(189,0,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center}

    @media (max-width:500px){ .form-grid{grid-template-columns:1fr} .keys-card{padding:15px} .key-item{flex-direction:column;align-items:flex-start} .key-item .actions{width:100%;display:flex;justify-content:flex-end;margin-top:8px} }
  </style>
</head>
<body>
  <div class="ambient-light"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

  <div class="container">
    <div class="fusion-card closed" id="mainCard">
      
      <div class="card-header" id="cardHeader">
        <div class="avatar-slot" id="avatarTarget" title="Gerenciar Chaves"></div>
        <div class="text-block">
          <div class="greeting-row">
            <span class="txt-thin" id="lblHello">Oi,</span>
            <span class="txt-heavy" id="lblName">Convidado</span>
          </div>
          <div class="brand-dual">DUAL</div>
        </div>
        <div class="clock-widget">
          <div class="time-display" id="clockTime">00:00</div>
          <span class="status-led">ONLINE</span>
        </div>
      </div>

      <div class="small-preview" id="smallPreview" title="Gerenciar Chaves">
        <div class="mini-avatar" id="smallMiniAvatar"></div>
        <div class="small-text" id="smallText">Aguardando ativação...</div>
        <div class="ident-badge" id="smallIdent">--</div>
      </div>

      <div class="card-body" id="cardBody">
        <div class="input-wrapper stagger-item">
          <input type="text" class="cyber-input" id="inputUser" placeholder="Identifique-se..." autocomplete="off" />
        </div>

        <div class="activation-wrap stagger-item">
          <div class="activation-toggle" onclick="toggleActivation()">
            <div style="display:flex;align-items:center;gap:8px">
              <div style="width:10px;height:10px;border-radius:99px;background:var(--neon-cyan)"></div>
              <strong style="letter-spacing:1px;font-size:0.9rem">Ativação ASCII</strong>
            </div>
            <div style="margin-left:auto;font-size:0.82rem;color:rgba(255,255,255,0.6)">BASE v1</div>
          </div>
          <div id="activationCard" class="activation-card activation-hidden">
            <div style="display:flex;align-items:flex-start;gap:10px">
              <div style="display:flex;align-items:center;gap:8px">
                <div class="mini-avatar" id="actMiniAvatar"></div>
                <div><div style="font-weight:700">CÉREBRO</div><div style="font-size:0.78rem;opacity:0.6"><span id="actName">User</span></div></div>
              </div>
              <div class="activation-badge" id="actBadge" style="margin-left:auto">v:--</div>
            </div>
            <pre id="actPre" class="activation-pre">Carregando...</pre>
            <div class="activation-controls">
              <button class="trigger-btn" id="copyActBtn">COPIAR</button>
              <button class="trigger-btn" id="downloadActBtn">PNG</button>
            </div>
          </div>
        </div>

        <div class="stagger-item">
          <div class="stats-grid">
            <div class="stat-box"><span class="stat-lbl">LATÊNCIA</span><span class="stat-val">12ms</span></div>
            <div class="stat-box"><span class="stat-lbl">SEGURANÇA</span><span class="stat-val" id="securityStatus">ABERTO</span></div>
            <div class="stat-box"><span class="stat-lbl">RITMO</span><span class="stat-val">BETA</span></div>
          </div>
          <div class="progress-container" style="margin-top:12px">
            <div class="bar-meta"><span>CICLO DIÁRIO</span><span id="cyclePercent">0%</span></div>
            <div class="bar-track"><div class="bar-fill" id="cycleFill"></div></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="toaster-wrap" id="toasterWrap"></div>

  <div id="keysModal" class="modal-overlay" aria-hidden="true">
    <div class="keys-card" role="dialog">
      <div class="keys-header">
        <div>
          <div id="keysTitle" style="font-weight:800;font-size:1.1rem;color:var(--neon-cyan)">USER KEYS MANAGER</div>
          <div style="color:rgba(255,255,255,0.6);font-size:0.85rem">Gerencie suas ESK Keys com segurança local.</div>
        </div>
        <button id="closeKeysBtn" class="small-btn">X</button>
      </div>

      <div class="key-list" id="keyList"></div>

      <div class="form-section">
        <div class="form-grid">
          <input id="keyNameInput" placeholder="Nome da chave (ex: Principal)" />
          <input id="keyTokenInput" type="password" placeholder="Token / ESK (Opcional)" />
        </div>
        <div class="form-row">
          <input id="keyWebhookInput" placeholder="Webhook URL (https://...)" style="flex:1" />
          <button id="testWebhookBtn" class="small-btn" title="Testar Conexão">PING</button>
        </div>
        <button id="addKeyBtn" class="small-btn" style="width:100%;margin-top:8px;background:rgba(255,255,255,0.1)">ADICIONAR CHAVE</button>
      </div>

      <div style="display:flex;gap:8px;justify-content:space-between;margin-top:15px;border-top:1px solid rgba(255,255,255,0.05);padding-top:12px">
        <div style="font-size:0.7rem;color:rgba(255,255,255,0.4);display:flex;align-items:center;gap:5px">
          <i data-lucide="shield-check" style="width:14px"></i> <span id="vaultStatusText">Cofre Aberto</span>
        </div>
        <div style="display:flex;gap:8px">
          <button id="lockVaultBtn" class="small-btn danger">BLOQUEAR</button>
          <button id="exportKeysBtn" class="small-btn">Export</button>
          <button id="importKeysBtn" class="small-btn">Import</button>
          <input id="importFileInput" type="file" accept="application/json" style="display:none" />
        </div>
      </div>
    </div>
  </div>

  <div id="vaultModal" class="modal-overlay" aria-hidden="true">
    <div class="keys-card">
      <div class="vault-icon"><i data-lucide="lock" style="width:24px;height:24px"></i></div>
      <h3 style="margin:0 0 10px 0;font-weight:800">ACESSO AO COFRE</h3>
      <p style="margin:0 0 15px 0;font-size:0.9rem;color:rgba(255,255,255,0.6)">Seus dados estão criptografados. Digite a senha para desbloquear.</p>
      <input type="password" id="vaultPassInput" class="cyber-input" style="text-align:center;margin-bottom:12px" placeholder="Senha..." />
      <div style="display:flex;gap:8px;justify-content:center">
         <button id="vaultCancelBtn" class="small-btn">Cancelar</button>
         <button id="vaultUnlockBtn" class="small-btn active-btn">DESBLOQUEAR</button>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();

    // ELEMENT REFERENCES
    const els = {
      card: document.getElementById('mainCard'),
      header: document.getElementById('cardHeader'),
      avatarTgt: document.getElementById('avatarTarget'),
      input: document.getElementById('inputUser'),
      lblHello: document.getElementById('lblHello'),
      lblName: document.getElementById('lblName'),
      clock: document.getElementById('clockTime'),
      smallPreview: document.getElementById('smallPreview'),
      smallMiniAvatar: document.getElementById('smallMiniAvatar'),
      smallText: document.getElementById('smallText'),
      smallIdent: document.getElementById('smallIdent'),
      actCard: document.getElementById('activationCard'),
      actPre: document.getElementById('actPre'),
      actName: document.getElementById('actName'),
      actMiniAvatar: document.getElementById('actMiniAvatar'),
      actBadge: document.getElementById('actBadge'),
      securityStatus: document.getElementById('securityStatus'),
      // Keys UI
      keysModal: document.getElementById('keysModal'),
      keyList: document.getElementById('keyList'),
      keyName: document.getElementById('keyNameInput'),
      keyToken: document.getElementById('keyTokenInput'),
      keyWebhook: document.getElementById('keyWebhookInput'),
      addKeyBtn: document.getElementById('addKeyBtn'),
      closeKeysBtn: document.getElementById('closeKeysBtn'),
      testWebhookBtn: document.getElementById('testWebhookBtn'),
      exportKeysBtn: document.getElementById('exportKeysBtn'),
      importKeysBtn: document.getElementById('importKeysBtn'),
      importFileInput: document.getElementById('importFileInput'),
      lockVaultBtn: document.getElementById('lockVaultBtn'),
      vaultStatusText: document.getElementById('vaultStatusText'),
      // Vault UI
      vaultModal: document.getElementById('vaultModal'),
      vaultPass: document.getElementById('vaultPassInput'),
      vaultUnlock: document.getElementById('vaultUnlockBtn'),
      vaultCancel: document.getElementById('vaultCancelBtn')
    };

    // --- CRYPTO UTILS (AES-GCM) ---
    const CRYPTO = {
      algo: { name: 'AES-GCM', length: 256 },
      pbkdf2: { name: 'PBKDF2', hash: 'SHA-256', iterations: 100000 },
      salt: window.crypto.getRandomValues(new Uint8Array(16)), // Runtime salt (ideal would be stored, simplifying for single file)
      
      async getKey(password, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
        return window.crypto.subtle.deriveKey({ ...this.pbkdf2, salt: salt }, keyMaterial, this.algo, false, ["encrypt", "decrypt"]);
      },
      
      async encrypt(data, password) {
        const salt = window.crypto.getRandomValues(new Uint8Array(16));
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const key = await this.getKey(password, salt);
        const encoded = new TextEncoder().encode(JSON.stringify(data));
        const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, encoded);
        
        // Bundle salt + iv + data
        const bundle = { s: Array.from(salt), iv: Array.from(iv), d: Array.from(new Uint8Array(encrypted)) };
        return JSON.stringify(bundle);
      },
      
      async decrypt(bundleStr, password) {
        try {
          const bundle = JSON.parse(bundleStr);
          const salt = new Uint8Array(bundle.s);
          const iv = new Uint8Array(bundle.iv);
          const data = new Uint8Array(bundle.d);
          const key = await this.getKey(password, salt);
          const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, data);
          return JSON.parse(new TextDecoder().decode(decrypted));
        } catch(e) { throw new Error("Senha incorreta ou dados corrompidos"); }
      }
    };

    // --- STATE & STORAGE ---
    const STORAGE_KEY = 'fusion_os_data_v2';
    let STATE = {
      keys: [], // {id, name, token, webhook, active}
      user: 'Convidado',
      isEncrypted: false,
      encryptedData: null
    };
    let SESSION_PASSWORD = null; // Memory only

    function saveData() {
      const payload = { keys: STATE.keys, user: STATE.user };
      if (SESSION_PASSWORD) {
        CRYPTO.encrypt(payload, SESSION_PASSWORD).then(enc => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ isEncrypted: true, data: enc }));
          STATE.isEncrypted = true;
          STATE.encryptedData = enc;
          updateSecurityUI();
        });
      } else {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ isEncrypted: false, data: payload }));
      }
    }

    async function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      
      const parsed = JSON.parse(raw);
      if (parsed.isEncrypted) {
        STATE.isEncrypted = true;
        STATE.encryptedData = parsed.data;
        updateSecurityUI();
        // Prompt unlock happens on Modal Open, not page load, to keep UI smooth
      } else {
        STATE.keys = parsed.data.keys || [];
        STATE.user = parsed.data.user || 'Convidado';
        updateInterface(STATE.user);
        renderKeysList();
      }
    }

    // --- UI UPDATES ---
    const hashStr = s => { let h=0xdeadbeef; for(let i=0;i<s.length;i++){h=Math.imul(h^s.charCodeAt(i),2654435761);} return (h^h>>>16)>>>0; };
    const createSvg = (id,sz) => `<svg viewBox="0 0 100 100" width="${sz}" height="${sz}"><defs><linearGradient id="g${id}"><stop offset="0%" stop-color="#00f2ff"/><stop offset="100%" stop-color="#bd00ff"/></linearGradient></defs><circle cx="50" cy="50" r="48" fill="#080b12" stroke="rgba(255,255,255,0.1)"/><circle cx="50" cy="50" r="20" fill="url(#g${id})" opacity="0.9"/></svg>`;
    const createMiniSvg = (name,sz=30) => {
      const s = hashStr(name||'D'); const h1=s%360; const h2=(s*37)%360;
      const grad = `<linearGradient id="gm${s}" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="hsl(${h1},90%,50%)"/><stop offset="1" stop-color="hsl(${h2},90%,50%)"/></linearGradient>`;
      return `<svg width="${sz}" height="${sz}" viewBox="0 0 32 32"><defs>${grad}</defs><rect width="32" height="32" rx="8" fill="#0a1016"/><circle cx="16" cy="16" r="6" fill="url(#gm${s})"/></svg>`;
    };

    function updateInterface(name){
      const safe = name || 'Convidado';
      els.lblName.innerText = safe;
      els.input.value = safe;
      const activeKey = STATE.keys.find(k=>k.active);
      
      els.smallIdent.innerText = activeKey ? activeKey.name : '--';
      els.actBadge.innerText = activeKey ? `key:${activeKey.name}` : 'v:--';
      
      els.smallMiniAvatar.innerHTML = createMiniSvg(safe);
      els.actMiniAvatar.innerHTML = createMiniSvg(safe,36);
      els.actName.innerText = safe;
      els.avatarTgt.innerHTML = createSvg('Main',64);

      const phrases = ["Foco estável.","Ritmo criativo.","Percepção sutil."];
      els.smallText.innerText = activeKey ? `${activeKey.name} [ATIVO]` : (safe==='Convidado'?'Aguardando...':`${safe} · ${phrases[safe.length%phrases.length]}`);

      const line = `+${'-'.repeat(safe.length+4)}+`;
      els.actPre.innerText = `${line}\n| ${safe.toUpperCase()} |\n${line}\nID: ${hashStr(safe).toString(16)}`;
    }

    function updateSecurityUI() {
      if (SESSION_PASSWORD) {
        els.securityStatus.innerText = "COFRE DESTRANCADO";
        els.securityStatus.style.color = "var(--neon-success)";
        els.vaultStatusText.innerText = "Cofre Protegido (Destrancado)";
        els.lockVaultBtn.innerText = "TRANCAR";
      } else if (STATE.isEncrypted) {
        els.securityStatus.innerText = "CRIPTOGRAFADO";
        els.securityStatus.style.color = "var(--neon-gold)";
        els.vaultStatusText.innerText = "Cofre Trancado";
        els.lockVaultBtn.innerText = "REDEFINIR";
      } else {
        els.securityStatus.innerText = "SEM PROTEÇÃO";
        els.securityStatus.style.color = "rgba(255,255,255,0.5)";
        els.vaultStatusText.innerText = "Cofre Aberto (Sem senha)";
        els.lockVaultBtn.innerText = "CRIAR SENHA";
      }
    }

    // --- KEYS MANAGER LOGIC ---
    function renderKeysList(){
      els.keyList.innerHTML = '';
      if(STATE.keys.length===0){ els.keyList.innerHTML = '<div style="color:rgba(255,255,255,0.3);text-align:center;padding:20px">Nenhuma chave armazenada.</div>'; return; }
      
      STATE.keys.forEach(k=>{
        const div = document.createElement('div');
        div.className = `key-item ${k.active?'active-item':''}`;
        
        const typeInfo = k.webhook ? '<span style="color:var(--neon-purple)">WEBHOOK</span>' : 'API KEY';
        div.innerHTML = `
          <div class="meta">
            <div style="font-weight:700;font-size:0.9rem">${escapeHtml(k.name)}</div>
            <div style="font-size:0.75rem;color:rgba(255,255,255,0.5)">${typeInfo}</div>
          </div>
          <div class="actions">
            ${!k.active ? `<button class="small-btn" onclick="setActiveKey('${k.id}')">ATIVAR</button>` : `<span style="font-size:0.7rem;font-weight:700;color:var(--neon-cyan);margin-right:10px">ATIVA</span>`}
            <button class="small-btn danger" onclick="removeKey('${k.id}')"><i data-lucide="trash-2" style="width:14px"></i></button>
          </div>
        `;
        els.keyList.appendChild(div);
      });
      lucide.createIcons();
    }

    function addKey() {
      const name = els.keyName.value.trim();
      const token = els.keyToken.value.trim();
      const webhook = els.keyWebhook.value.trim();
      if(!name){ showToaster('Nome obrigatório','error'); return; }

      const newKey = { id: Date.now().toString(36), name, token, webhook, active: STATE.keys.length===0 };
      STATE.keys.push(newKey);
      saveData();
      renderKeysList();
      updateInterface(STATE.user);
      els.keyName.value=''; els.keyToken.value=''; els.keyWebhook.value='';
      showToaster('Chave adicionada!', 'success');
    }

    window.removeKey = (id) => {
      if(confirm('Remover chave permanentemente?')){
        STATE.keys = STATE.keys.filter(k=>k.id!==id);
        saveData(); renderKeysList(); updateInterface(STATE.user);
      }
    };

    window.setActiveKey = (id) => {
      STATE.keys.forEach(k=> k.active = (k.id===id));
      saveData(); renderKeysList(); updateInterface(STATE.user);
      showToaster('Chave ativa atualizada.', 'success');
    };

    // --- WEBHOOK TEST ---
    els.testWebhookBtn.addEventListener('click', async () => {
       const url = els.keyWebhook.value.trim();
       if(!url) return showToaster('Insira uma URL', 'error');
       
       els.testWebhookBtn.innerHTML = '...';
       try {
         const controller = new AbortController();
         setTimeout(()=>controller.abort(), 4000);
         // No-cors mode allows sending data to opaque origins (common for webhooks)
         await fetch(url, { method: 'POST', body: JSON.stringify({ping:true}), mode: 'no-cors', signal: controller.signal });
         showToaster('Envio realizado (Ping)', 'success');
       } catch(e) {
         showToaster('Falha na conexão', 'error');
       } finally {
         els.testWebhookBtn.innerText = 'PING';
       }
    });

    // --- VAULT FLOW ---
    function openManager() {
      if (STATE.isEncrypted && !SESSION_PASSWORD) {
        // Needs unlock
        els.vaultModal.style.display = 'flex';
        els.vaultModal.setAttribute('aria-hidden', 'false');
        els.vaultPass.focus();
      } else {
        // Open Manager
        els.keysModal.style.display = 'flex';
        els.keysModal.setAttribute('aria-hidden', 'false');
      }
    }

    els.vaultUnlock.addEventListener('click', async () => {
      const pass = els.vaultPass.value;
      try {
        const decrypted = await CRYPTO.decrypt(STATE.encryptedData, pass);
        SESSION_PASSWORD = pass;
        STATE.keys = decrypted.keys;
        STATE.user = decrypted.user;
        
        els.vaultModal.style.display = 'none';
        els.keysModal.style.display = 'flex';
        els.vaultPass.value = '';
        renderKeysList();
        updateSecurityUI();
        showToaster('Cofre destrancado.', 'success');
      } catch(e) {
        showToaster('Senha incorreta.', 'error');
        els.vaultPass.classList.add('vibe-gold'); // shake effect reuse
        setTimeout(()=>els.vaultPass.classList.remove('vibe-gold'), 500);
      }
    });
    
    els.lockVaultBtn.addEventListener('click', () => {
       if (!SESSION_PASSWORD && !STATE.isEncrypted) {
         // Create Password
         const newPass = prompt("Defina uma senha para o Cofre:");
         if(newPass) {
           SESSION_PASSWORD = newPass;
           saveData();
           showToaster("Cofre criado e trancado.", 'success');
         }
       } else {
         // Lock
         SESSION_PASSWORD = null;
         els.keysModal.style.display = 'none';
         showToaster("Cofre trancado.", 'success');
       }
       updateSecurityUI();
    });

    els.vaultCancel.addEventListener('click', ()=> els.vaultModal.style.display='none');
    els.closeKeysBtn.addEventListener('click', ()=> els.keysModal.style.display='none');
    els.addKeyBtn.addEventListener('click', addKey);
    
    // Import/Export
    els.exportKeysBtn.addEventListener('click', ()=>{
      const data = JSON.stringify(STATE.keys, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='fusion_keys.json'; a.click();
    });
    els.importKeysBtn.addEventListener('click', ()=> els.importFileInput.click());
    els.importFileInput.addEventListener('change', (e)=>{
       const f = e.target.files[0];
       if(f) {
         const r = new FileReader();
         r.onload = (ev) => {
           try { STATE.keys = JSON.parse(ev.target.result); saveData(); renderKeysList(); showToaster('Chaves importadas!','success'); }
           catch(e){ showToaster('Arquivo inválido','error'); }
         };
         r.readAsText(f);
       }
    });

    // --- INTERACTION CORE (GESTURES) ---
    let state = { isOrb:false, isHud:false, isDragging:false, startX:0, startY:0, timer:null };
    
    els.card.addEventListener('pointerdown', handleStart);
    document.addEventListener('pointermove', handleMove);
    document.addEventListener('pointerup', handleEnd);

    // Click on Avatar in Card Mode -> Open Manager
    els.avatarTgt.addEventListener('click', (e)=>{
       if(!state.isOrb && !state.isHud) openManager();
    });

    function handleStart(e) {
      if(e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('.keys-card')) return;
      
      // If card expanded, only header drags
      if(!state.isOrb && !state.isHud && !els.header.contains(e.target)) return;

      state.startX = e.clientX; state.startY = e.clientY;
      state.isDragging = false;
      
      // Long Press Logic
      state.timer = setTimeout(() => {
        // If Orb -> Long Press opens Manager
        if(state.isOrb) {
           openManager();
        } 
        // If Card -> Long Press becomes Orb
        else if (!state.isHud) {
           transmuteToOrb(e.clientX, e.clientY);
        }
      }, 600);

      if(state.isOrb) {
         els.card.setPointerCapture(e.pointerId);
         const rect = els.card.getBoundingClientRect();
         state.offsetX = e.clientX - rect.left;
         state.offsetY = e.clientY - rect.top;
      }
    }

    function handleMove(e) {
      if(!state.timer && !state.isOrb) return;
      const dist = Math.hypot(e.clientX - state.startX, e.clientY - state.startY);
      if(dist > 10) {
        if(state.timer) { clearTimeout(state.timer); state.timer = null; }
        if(state.isOrb) {
          state.isDragging = true;
          els.card.style.left = (e.clientX - state.offsetX) + 'px';
          els.card.style.top = (e.clientY - state.offsetY) + 'px';
          els.card.style.transform = 'none';
        }
      }
    }

    function handleEnd(e) {
      if(state.timer) { clearTimeout(state.timer); state.timer = null; }
      if(state.isDragging && state.isOrb) {
        state.isDragging = false; snapOrb(e.clientX, e.clientY); return;
      }
      const dist = Math.hypot(e.clientX - state.startX, e.clientY - state.startY);
      if(dist < 10) {
        // Click Logic
        if(state.isOrb || state.isHud) revertToCard();
        else toggleCardState();
      }
    }

    function transmuteToOrb(x,y) {
      if(navigator.vibrate) navigator.vibrate(50);
      els.card.classList.add('orb','closed'); els.card.classList.remove('content-visible');
      els.card.style.left=(x-34)+'px'; els.card.style.top=(y-34)+'px';
      state.isOrb=true; state.isHud=false;
    }

    function snapOrb(x,y) {
      if(y < 80) {
        state.isHud=true; state.isOrb=false; els.card.classList.add('hud'); els.card.classList.remove('orb');
        els.card.style.left=''; els.card.style.top=''; els.card.style.transform='';
      } else {
        const tx = x < window.innerWidth/2 ? 15 : window.innerWidth-83;
        els.card.style.transition='left 0.4s ease, top 0.4s ease'; els.card.style.left=tx+'px';
        setTimeout(()=>els.card.style.transition='',400);
      }
    }

    function revertToCard() {
      state.isOrb=false; state.isHud=false;
      els.card.style.transition='all 0.5s var(--ease-smooth)'; els.card.style.left=''; els.card.style.top=''; els.card.style.width=''; els.card.style.height=''; els.card.style.transform='';
      els.card.classList.remove('orb','hud','closed');
      setTimeout(()=>els.card.classList.add('content-visible'),300);
    }

    function toggleCardState() {
      if(els.card.classList.contains('animating')) return;
      const isClosed = els.card.classList.contains('closed');
      els.card.classList.add('animating');
      if(isClosed) {
        els.card.classList.remove('closed');
        els.card.animate([{transform:'scale(0.95)',opacity:0.8},{transform:'scale(1)',opacity:1}],{duration:400,easing:'cubic-bezier(0.34,1.3,0.64,1)'})
        .onfinish = ()=>{ els.card.classList.remove('animating'); els.card.classList.add('content-visible'); }
      } else {
        els.card.classList.remove('content-visible');
        els.card.animate([{transform:'translateY(0)',opacity:1},{transform:'translateY(10px)',opacity:1}],{duration:200,easing:'ease-in'})
        .onfinish = ()=>{ els.card.classList.add('closed'); els.card.classList.remove('animating'); }
      }
    }

    // --- MISC UTILS ---
    function escapeHtml(s){ return s ? s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : ''; }
    function showToaster(txt,type='default'){ const t=document.createElement('div'); t.className=`toaster ${type}`; t.innerText=txt; document.getElementById('toasterWrap').appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},2500); }
    function toggleActivation(){ const h=els.actCard.classList.contains('activation-hidden'); els.actCard.classList.toggle('activation-hidden',!h); els.actCard.classList.toggle('activation-open',h); }
    
    // Copy/Download
    document.getElementById('copyActBtn').addEventListener('click', ()=>{
       const active = STATE.keys.find(k=>k.active);
       const append = active ? `\n\n[Active Key: ${active.name}]` : '';
       navigator.clipboard.writeText(els.actPre.innerText + append).then(()=>showToaster('Copiado!'));
    });
    document.getElementById('downloadActBtn').addEventListener('click', async()=>{
       const canvas = await html2canvas(els.actPre, {scale:2, backgroundColor:null});
       canvas.toBlob(b=>{ const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='activation.png'; a.click(); });
    });
    
    // Init
    els.input.addEventListener('input', (e)=>{ STATE.user=e.target.value; updateInterface(e.target.value); saveData(); });
    setTimeout(()=>{ els.card.classList.add('active'); els.avatarTgt.classList.add('shown'); loadData(); }, 100);
    setInterval(()=>{ els.clock.innerText = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); },1000);

  </script>

<!-- BEGIN: Dual Infodose — OpenRouter / LocalStorage Sync Patch -->
<script>
(function(){
  /*
    Chaves usadas (única fonte da verdade):
    di_apiKey
    di_modelName
    di_trainingText
    di_trainingFileName
    di_userName
    di_infodoseName
    di_assistantEnabled
    di_trainingActive
  */

  /* =========================
     CHAT ⇆ LOCALSTORAGE
  ========================= */
  function chatSyncOnStorage() {
    try {
      // API KEY
      if (typeof apiKey !== 'undefined') {
        const newKey = localStorage.getItem('di_apiKey') || '';
        if (newKey && newKey !== apiKey) {
          apiKey = newKey;
          const keyEl = document.getElementById('apiKeyInput');
          if (keyEl) keyEl.value = apiKey;
        }
      }

      // MODEL
      if (typeof modelName !== 'undefined') {
        const newModel = localStorage.getItem('di_modelName') || '';
        if (newModel && newModel !== modelName) {
          modelName = newModel;
          const mEl = document.getElementById('modelInput');
          if (mEl) mEl.value = modelName;
        }
      }

      // TRAINING
      if (typeof training !== 'undefined') {
        const t = localStorage.getItem('di_trainingText');
        if (t && training !== t) {
          training = t;
          const fname = localStorage.getItem('di_trainingFileName') || '';
          const fEl = document.getElementById('trainingFileName');
          if (fEl && fname) fEl.innerText = fname;
        }
      }

      // USER / INFODOSE
      if (typeof userName !== 'undefined')
        userName = localStorage.getItem('di_userName') || '';

      if (typeof infodoseName !== 'undefined')
        infodoseName = localStorage.getItem('di_infodoseName') || '';

      const dispU = document.getElementById('displayUser');
      const dispI = document.getElementById('displayInfodose');

      if (dispU) dispU.innerText = 'User: ' + (userName || '—');
      if (dispI) dispI.innerText = 'Infodose: ' + (infodoseName || '—');

    } catch (e) {
      console.warn('[Dual Sync] chatSync error', e);
    }
  }

  /* =========================
     CARD ⇆ LOCALSTORAGE
  ========================= */
  function cardImportDiApiKey() {
    try {
      if (typeof STATE === 'undefined' || !Array.isArray(STATE.keys)) return;

      const sk = localStorage.getItem('di_apiKey');
      const model = localStorage.getItem('di_modelName') || '';

      if (!sk) return;

      let key = STATE.keys.find(k => k.token === sk);

      // Importa se não existir
      if (!key) {
        STATE.keys.forEach(k => k.active = false);

        STATE.keys.unshift({
          id: 'import-' + Date.now(),
          name: 'Imported-SK',
          token: sk,
          model: model,
          webhook: '',
          active: true
        });
      } else {
        STATE.keys.forEach(k => k.active = (k.token === sk));
      }

      if (typeof saveData === 'function') saveData();
      if (typeof renderKeysList === 'function') renderKeysList();
      if (typeof updateInterface === 'function') updateInterface(STATE.user);

    } catch (e) {
      console.warn('[Dual Sync] cardImport error', e);
    }
  }

  /* =========================
     CARD → CHAT (active key)
  ========================= */
  try {
    if (typeof window.setActiveKey === 'function') {
      const original = window.setActiveKey.bind(window);

      window.setActiveKey = function(id) {
        original(id);

        try {
          const active = STATE?.keys?.find(k => k.active);
          if (active?.token) {
            localStorage.setItem('di_apiKey', active.token);
            if (active.model)
              localStorage.setItem('di_modelName', active.model);
          }
        } catch(e){}
      };
    }
  } catch(e){}

  /* =========================
     STORAGE EVENT (multi-page)
  ========================= */
  window.addEventListener('storage', (e) => {
    const keys = [
      'di_apiKey',
      'di_modelName',
      'di_trainingText',
      'di_trainingFileName',
      'di_userName',
      'di_infodoseName',
      'di_assistantEnabled',
      'di_trainingActive'
    ];

    if (keys.includes(e.key)) {
      chatSyncOnStorage();
      cardImportDiApiKey();
    }
  });

  /* =========================
     INIT
  ========================= */
  setTimeout(() => {
    chatSyncOnStorage();
    cardImportDiApiKey();
  }, 80);

})();
</script>
<!-- END: Dual Infodose — OpenRouter / LocalStorage Sync Patch -->

</body>
</html>
